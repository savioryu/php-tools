<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>WechatSDK.php - WeChatSDK</title>
    <link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/bootstrap-responsive.min.css" />
  </head>
  <body>

    <div class="container-fluid">
      <div id="header">
        <h1 class="logo">
          <a href="../index.html">
            <img src="http://admin.wechat.com/en_US/htmledition/images/logo147d79.png" title="WeChatSDK"/>
          </a></h1>
        <div class="version">
          <em>API Docs for: 0.5</em>
        </div>
      </div>

      <div class="row-fluid">
        <div id="main" class="span9"> <div class="content"><h2>WechatSDK.php</h2><pre class="code prettyprint linenums">&lt;?PHP
/**
 * @author zemzheng@tencent.com / zemzheng@gmail.com
 * @fileOverview WeChat Callback SDK
 * @version 0.5
 */

/**
 * @class WeChatSDK
 * @description WeChat Callback API SDK
 */
class WeChatSDK{
  # {{{ SETTING ==========================================================
  private static $_api_url_root = &#x27;https://api.weixin.qq.com&#x27;;
  private static $_errList = array(
    ## en_US
    ## http://admin.wechat.com/wiki/index.php?title=Return_Codes
    &#x27;-1&#x27; =&gt; &#x27;System busy&#x27;, &#x27;0&#x27; =&gt; &#x27;Request succeeded&#x27;, &#x27;40001&#x27; =&gt; &#x27;Verification failed&#x27;, &#x27;40002&#x27; =&gt; &#x27;Invalid certificate type&#x27;, &#x27;40003&#x27; =&gt; &#x27;Invalid OPEN ID&#x27;, &#x27;40004&#x27; =&gt; &#x27;Invalid media file type&#x27;, &#x27;40005&#x27; =&gt; &#x27;Invalid file type&#x27;, &#x27;40006&#x27; =&gt; &#x27;Invalid file size&#x27;, &#x27;40007&#x27; =&gt; &#x27;Invalid media file ID&#x27;, &#x27;40008&#x27; =&gt; &#x27;Invalid message type&#x27;, &#x27;40009&#x27; =&gt; &#x27;Invalid image file size&#x27;, &#x27;40010&#x27; =&gt; &#x27;Invalid audio file size&#x27;, &#x27;40011&#x27; =&gt; &#x27;Invalid video file size&#x27;, &#x27;40012&#x27; =&gt; &#x27;Invalid thumbnail file size&#x27;, &#x27;40013&#x27; =&gt; &#x27;Invalid APP ID&#x27;, &#x27;41001&#x27; =&gt; &#x27;Parameter missing: access_token&#x27;, &#x27;41002&#x27; =&gt; &#x27;Parameter missing: appid&#x27;, &#x27;41003&#x27; =&gt; &#x27;Parameter missing: refresh_token&#x27;, &#x27;41004&#x27; =&gt; &#x27;Parameter missing: secret&#x27;, &#x27;41005&#x27; =&gt; &#x27;Multimedia file data missing&#x27;, &#x27;41006&#x27; =&gt; &#x27;Parameter missing: media_id&#x27;, &#x27;42001&#x27; =&gt; &#x27;access_token timed out&#x27;, &#x27;43001&#x27; =&gt; &#x27;GET request required&#x27;, &#x27;43002&#x27; =&gt; &#x27;POST request required&#x27;, &#x27;43003&#x27; =&gt; &#x27;HTTPS request required&#x27;, &#x27;44001&#x27; =&gt; &#x27;Multimedia file is empty&#x27;, &#x27;44002&#x27; =&gt; &#x27;POST package is empty&#x27;, &#x27;44003&#x27; =&gt; &#x27;Rich media message is empty&#x27;, &#x27;45001&#x27; =&gt; &#x27;Error source: multimedia file size&#x27;, &#x27;45002&#x27; =&gt; &#x27;Message contents too long&#x27;, &#x27;45003&#x27; =&gt; &#x27;Title too long&#x27;, &#x27;45004&#x27; =&gt; &#x27;Description too long&#x27;, &#x27;45005&#x27; =&gt; &#x27;URL too long&#x27;, &#x27;45006&#x27; =&gt; &#x27;Image URL too long&#x27;, &#x27;45007&#x27; =&gt; &#x27;Audio play time over limit&#x27;, &#x27;45008&#x27; =&gt; &#x27;Rich media messages over limit&#x27;, &#x27;45009&#x27; =&gt; &#x27;Error source: interface call&#x27;, &#x27;46001&#x27; =&gt; &#x27;Media data missing&#x27;, &#x27;47001&#x27; =&gt; &#x27;Error while extracting JSON/XML contents&#x27;
  );
  # / SETTING }}} ========================================================

  # {{{ METHODS ==========================================================

  /**
   *
   * @method __construct
   * @param {String} $APPSECRET           : APPSECRET
   * @param {String} $APPID               : APPID
   * @param {String} $_token              : The Token set by YOU
   * @param {Array} $_handleReqFuncs      : [Selectable] Functions, for handle Request
   *  &lt;pre&gt;
   *    array(
   *      &#x27;common&#x27;      =&gt; function($postObj){},  # Handler for all data/event push request. [handleReqFuncs::common]
   *
   *        &#x27;text&#x27;        =&gt; function($postObj){},  # Handler for text           push request. [handleReqFuncs::text]
   *        &#x27;image&#x27;       =&gt; function($postObj){},  # Handler for image          push request. [handleReqFuncs::image]
   *        &#x27;location&#x27;    =&gt; function($postObj){},  # Handler for location       push request. [handleReqFuncs::location]
   *        &#x27;link&#x27;        =&gt; function($postObj){},  # Handler for link           push request. [handleReqFuncs::link]
   *        &#x27;event&#x27;       =&gt; function($postObj){},  # Handler for event          push request. [handleReqFuncs::event]
   *
   *      &#x27;accessCheck&#x27; =&gt; function(){},          # Handler for CallBack API Verification [handleReqFuncs::accessCheck]
   *      &#x27;404&#x27;         =&gt; function(){},          # Handler for other case                [handleReqFuncs::404]
   *    )
   *  &lt;/pre&gt;
   * @param {Array} $_actionHookFuncs     : [Selectable] Common Functions for each instance
   * &lt;pre&gt;
   *    array(
   *      &#x27;beforeSend&#x27; =&gt; function($msg){} # @see event actionHook::beforeSend
   *    )
   * &lt;/pre&gt;
   * @example
   * &lt;pre&gt;
   * // Your codes here...
   * $wechat = new WeChatSDK(
   *   $APPSECRET, $APPID, $_token,
   *   $_handleReqFuncs     ,
   *   $_actionHookFuncs
   * );
   * &lt;/pre&gt;
   */
  public function __construct(
    $APPSECRET, $APPID, $_token, 
    $_handleReqFuncs      = array(),
    $_actionHookFuncs = array()
  ){
    $this-&gt;APPSECRET    = $APPSECRET;
    $this-&gt;APPID        = $APPID;

    $this-&gt;_token           = $_token;
    $this-&gt;_handleReqFuncs  = $_handleReqFuncs;
    self::$_actionHookFuncs = $_actionHookFuncs;
  }

  /**
   * @method accessDataPush
   * @description Start to handle current HTTP Request.
   * @example
   * &lt;pre&gt;
   * // Your codes here ...
   * $wechat = new WeChatSDK($APPSECRET, $APPID, $_token,
   *  $_handleReqFuncs     ,
   *   $_actionHookFuncs
   * );
   * $wechat-&gt;accessDataPush();
   * &lt;/pre&gt;
   */
  public function accessDataPush(){
    if(isset($GLOBALS[&quot;HTTP_RAW_POST_DATA&quot;])){
      $postObj = simplexml_load_string(
        $GLOBALS[&quot;HTTP_RAW_POST_DATA&quot;],
        &#x27;SimpleXMLElement&#x27;, 
        LIBXML_NOCDATA
      );
      $postObj = $this-&gt;_handlePostObj($postObj);

      // Call Special Request Handle Function 
      $this-&gt;_runHandleReqFuncByType($postObj[&#x27;type&#x27;], $postObj);
      // Call Common Request Handle Function
      /**
       * @event handleReqFuncs::common
       * @description Trigger when receive push data. 
       * &lt;br/&gt; It can be handleReqFuncs::[text/image/location/link/event]
       * @example
       * &lt;pre&gt;
       * // How to set it?
       * new WeChatSDK(
       *    $APPSECRET, 
       *    $APPID,
       *    $token,
       *    array(
       *      &#x27;common&#x27; =&gt; 
       *    ),
       *    $actionHookFuncs
       * );
       * &lt;/pre&gt;
        */

      /**
       * @event handleReqFuncs::text
       * @description Trigger when receive text data push
       * @param {Array} Text Msg Data
       * &lt;pre&gt;
       *    array(
       *      # common
       *      &#x27;from&#x27; =&gt; # {String} : id, who send this msg
       *      &#x27;to&#x27;   =&gt; # {String} : id, who received this msg
       *      &#x27;time&#x27; =&gt; # {Int}    : When is the msg created?
       *      &#x27;type&#x27; =&gt; # {String} : msg type
       *      &#x27;id&#x27;   =&gt; # {String} : msg id
       *      # special
       *      &#x27;text&#x27; =&gt; # {String} : Msg string
       *    )
       * &lt;/pre&gt;
       */

      /**
       * @event handleReqFuncs::image
       * @description Trigger when receive image data push
       * @param {Array} image Msg Data
       * &lt;pre&gt;
       *    array(
       *      # common
       *      &#x27;from&#x27; =&gt; # {String} : id, who send this msg
       *      &#x27;to&#x27;   =&gt; # {String} : id, who received this msg
       *      &#x27;time&#x27; =&gt; # {Int}    : When is the msg created?
       *      &#x27;type&#x27; =&gt; # {String} : msg type
       *      &#x27;id&#x27;   =&gt; # {String} : msg id
       *      # special
       *      &#x27;url&#x27;  =&gt; # {String} image url
       *    )
       * &lt;/pre&gt;
       */

      /**
       * @event handleReqFuncs::location
       * @description Trigger when receive image data push
       * @param {Array} location Msg Data
       * &lt;pre&gt;
       *    array(
       *      # common
       *      &#x27;from&#x27; =&gt; # {String} : id, who send this msg
       *      &#x27;to&#x27;   =&gt; # {String} : id, who received this msg
       *      &#x27;time&#x27; =&gt; # {Int}    : When is the msg created?
       *      &#x27;type&#x27; =&gt; # {String} : msg type
       *      &#x27;id&#x27;   =&gt; # {String} : msg id
       *      # special
       *      &#x27;X&#x27; =&gt; # {float}  : Latitude
       *      &#x27;Y&#x27; =&gt; # {float}  : Longitude
       *      &#x27;S&#x27; =&gt; # {float}  : Scale
       *      &#x27;I&#x27; =&gt; # {String} : Location info
       *    )
       * &lt;/pre&gt;
       */

      /**
       * @event handleReqFuncs::link
       * @description Trigger when receive link data push
       * @param {Array} link Msg Data
       * &lt;pre&gt;
       *    array(
       *      # common
       *      &#x27;from&#x27; =&gt; # {String} : id, who send this msg
       *      &#x27;to&#x27;   =&gt; # {String} : id, who received this msg
       *      &#x27;time&#x27; =&gt; # {Int}    : When is the msg created?
       *      &#x27;type&#x27; =&gt; # {String} : msg type
       *      &#x27;id&#x27;   =&gt; # {String} : msg id
       *      # special
       *      &#x27;title&#x27; =&gt; # {String} : Link title
       *      &#x27;desc&#x27; =&gt;  # {String} : Link description
       *      &#x27;url&#x27; =&gt;   # {String} : Link url
       *    )
       * &lt;/pre&gt;
       */

      /**
       * @event handleReqFuncs::event
       * @description Trigger when receive event data push
       * @param {Array} event Msg Data
       * &lt;pre&gt;
       *    array(
       *      # common
       *      &#x27;from&#x27; =&gt; # {String} : id, who send this msg
       *      &#x27;to&#x27;   =&gt; # {String} : id, who received this msg
       *      &#x27;time&#x27; =&gt; # {Int}    : When is the msg created?
       *      &#x27;type&#x27; =&gt; # {String} : msg type
       *      &#x27;id&#x27;   =&gt; # {String} : msg id
       *      # special
       *      &#x27;event&#x27; =&gt; # {String} : event type
       *      &#x27;key&#x27;   =&gt; # {String} : event key
       *    )
       * &lt;/pre&gt;
       */
      $this-&gt;_runHandleReqFuncByType(&#x27;common&#x27;, $postObj);

    } else if(isset($_GET[&#x27;echostr&#x27;])) {
      /**
       * @event handleReqFuncs::accessCheck
       * @description Trigger when request CallBack API Verification 
       */
      $this-&gt;_runHandleReqFuncByType(&#x27;accessCheck&#x27;);
      if($this-&gt;_checkSignature()){
        echo $_GET[&#x27;echostr&#x27;];
      }
    } else {
      /**
       * @event handleReqFuncs::404
       * @description Unknow Request Handler.              
       */
      if( !$this-&gt;_runHandleReqFuncByType(&#x27;404&#x27;) ){
        header(&#x27;HTTP/1.1 404 Not Found&#x27;);
        header(&#x27;Status: 404 Not Found&#x27;);
      }
    }
  }

  /**
   * @method sendRichMsg
   * @static
   * @param {String} $to   : id, who will get the msg
   * @param {String} $from : id, who sent the msg
   * @param {Array} $list  : rich msg list. less then 10 items.
   * &lt;strong&gt;If you pass 10+ msg in, only 10 before will be send.&lt;/strong&gt;
   * &lt;pre&gt;
   *          array(
   *            array(
   *              &#x27;title&#x27; =&gt; # {String} =&gt; sub msg title
   *              &#x27;desc&#x27;  =&gt; # {String} =&gt; sub msg description
   *              &#x27;image&#x27; =&gt; # {String} =&gt; sum msg image
   *              &#x27;url&#x27;   =&gt; # {String} =&gt; sub msg url
   *            ),
   *            ...
   *          )
   * &lt;/pre&gt;
   * @param {bool} $flag   : Started this msg [default = false]
   * @example
   * &lt;pre&gt;
   * // Your codes here...
   * $handleText = function($postObj){
   *    WeChatSDK::sendRichMsg( $postObj[&#x27;from&#x27;], $postObj[&#x27;to&#x27;], array(
   *      array(
   *              &#x27;title&#x27; =&gt; &#x27;title 1&#x27;,
   *              &#x27;desc&#x27;  =&gt; &#x27;desc 1&#x27;,
   *              &#x27;image&#x27; =&gt; &#x27;http://localhost/image1&#x27;,
   *              &#x27;url&#x27;   =&gt; &#x27;http://localhost/url1&#x27;
   *      ),
   *      array(
   *              &#x27;title&#x27; =&gt; &#x27;title 2&#x27;,
   *              &#x27;desc&#x27;  =&gt; &#x27;desc 2&#x27;,
   *              &#x27;image&#x27; =&gt; &#x27;http://localhost/image2&#x27;,
   *              &#x27;url&#x27;   =&gt; &#x27;http://localhost/url2&#x27;
   *      )
   *    ) );
   * };
   * $wechat = WeChatSDK($APPSECRET, $APPID, $_token, array(
   *    &#x27;text&#x27; =&gt; $handleText
   * ));
   * &lt;/pre&gt;
   */
  static public function sendRichMsg($to, $from, $list, $flag = false){
    $i  = 0;
    $ii = count($list);
    if($ii &gt; 10){ $ii = 10; }
    $content = array();
    while($i &lt; $ii){
      $item = $list[$i++];
      array_push(
        $content,
        sprintf(
          &#x27;&lt;item&gt;
            &lt;Title&gt;&lt;![CDATA[%s]]&gt;&lt;/Title&gt;
            &lt;Description&gt;&lt;![CDATA[%s]]&gt;&lt;/Description&gt;
            &lt;PicUrl&gt;&lt;![CDATA[%s]]&gt;&lt;/PicUrl&gt;
            &lt;Url&gt;&lt;![CDATA[%s]]&gt;&lt;/Url&gt;
          &lt;/item&gt;&#x27;,
          $item[&#x27;title&#x27;],
          $item[&#x27;desc&#x27;],
          $item[&#x27;image&#x27;],
          $item[&#x27;url&#x27;]
        )
      );
    }
    
    self::_send(sprintf( 
      &#x27;&lt;xml&gt;
        &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;
        &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;
        &lt;CreateTime&gt;%s&lt;/CreateTime&gt;
        &lt;MsgType&gt;&lt;![CDATA[news]]&gt;&lt;/MsgType&gt;
        &lt;Content&gt;&lt;![CDATA[]]&gt;&lt;/Content&gt;
        &lt;ArticleCount&gt;%s&lt;/ArticleCount&gt;
        &lt;Articles&gt;%s&lt;/Articles&gt;
        &lt;FuncFlag&gt;%s&lt;/FuncFlag&gt;
      &lt;/xml&gt;&#x27;,
      $to,
      $from,
      time(),
      $ii,
      implode(&#x27;&#x27;,$content),
      $flag
    ));
    
  }

  /**
   * @method sendMusic
   * @static
   * @param {String} $_to   : id, who will get the msg
   * @param {String} $_from : id, who sent the msg
   * @param {Array} $_music : Musci info list
   * &lt;pre&gt;
   *                    array(
   *                      &#x27;title&#x27;  =&gt; # {String} =&gt; music title
   *                      &#x27;desc&#x27;   =&gt; # {String} =&gt; music description
   *                      &#x27;url&#x27;    =&gt; # {String} =&gt; music url
   *                      &#x27;hq_url&#x27; =&gt; # {String} =&gt; high quality music url， default = $_music[&#x27;music_url&#x27;]
   *                    )
   * &lt;/pre&gt;
   * @param {bool} $flag    : Started this msg [default = false]
   * @example 
   * &lt;pre&gt;
   * WeChatSDK::sendMusic( $postObj[&#x27;from&#x27;], $postObj[&#x27;to&#x27;], array(
   *    &#x27;title&#x27;  =&gt; &#x27;music title&#x27;,
   *    &#x27;desc&#x27;   =&gt; &#x27;music description&#x27;,
   *    &#x27;url&#x27;    =&gt; &#x27;music url&#x27;,
   *    &#x27;hq_url&#x27; =&gt; &#x27;high quality music url&#x27;
   * ) );
   * &lt;/pre&gt;
   */
  static public function sendMusic($_to, $_from, $_music, $flag = 0) {
    if(!isset($_music[&#x27;hq_url&#x27;])){
      $_music[&#x27;hq_url&#x27;] = $_music[&#x27;url&#x27;];
    }
    self::_send(sprintf(
      &#x27;&lt;xml&gt;
         &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;
         &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;
         &lt;CreateTime&gt;%s&lt;/CreateTime&gt;
         &lt;MsgType&gt;&lt;![CDATA[music]]&gt;&lt;/MsgType&gt;
         &lt;Music&gt;
           &lt;Title&gt;&lt;![CDATA[%s]]&gt;&lt;/Title&gt;
           &lt;Description&gt;&lt;![CDATA[%s]]&gt;&lt;/Description&gt;
           &lt;MusicUrl&gt;&lt;![CDATA[%s]]&gt;&lt;/MusicUrl&gt;
           &lt;HQMusicUrl&gt;&lt;![CDATA[%s]]&gt;&lt;/HQMusicUrl&gt;
         &lt;/Music&gt;
         &lt;FuncFlag&gt;0&lt;/FuncFlag&gt;
       &lt;/xml&gt;&#x27;,
      $_to,
      $_from,
      time(),
      $_music[&#x27;title&#x27;],
      $_music[&#x27;desc&#x27;],
      $_music[&#x27;url&#x27;],
      $_music[&#x27;hq_url&#x27;],
      $flag
    ));
  }

  /**
   * @method sendText
   * @static
   * @param {String} $_to      : id, who will get the msg
   * @param {String} $_from    : id, who sent the msg
   * @param {String} $_content : msg content text
   * @param {bool} $flag       : Started this msg [default = false]
   * @example
   * &lt;pre&gt;
   * WeChatSDK::sendText( $postObj[&#x27;from&#x27;], $postObj[&#x27;to&#x27;], &#x27;Hello&#x27;);
   * &lt;/pre&gt;
   */
  static public function sendText($_to, $_from, $_content, $flag = 0){
    self::_send(sprintf(
      &#x27;&lt;xml&gt;
        &lt;ToUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/ToUserName&gt;
        &lt;FromUserName&gt;&lt;![CDATA[%s]]&gt;&lt;/FromUserName&gt;
        &lt;CreateTime&gt;%s&lt;/CreateTime&gt;
        &lt;MsgType&gt;&lt;![CDATA[text]]&gt;&lt;/MsgType&gt;
        &lt;Content&gt;&lt;![CDATA[%s]]&gt;&lt;/Content&gt;
        &lt;FuncFlag&gt;%s&lt;/FuncFlag&gt;
      &lt;/xml&gt;&#x27;,
      $_to,
      $_from,
      time(),
      $_content,
      $flag
    ));
  }

  # / METHODS }}} =====================

  private static function _send($msg){
    /**
     * @event actionHook::beforeSend
     * @description before send msg to our customer, you can log/stop it by this event.&lt;br/&gt;
     * @example
     * &lt;pre&gt;
     * // How to set it?
     * new WeChatSDK(
     *    $APPSECRET, 
     *    $APPID,
     *    $token,
     *    $handleReqFuncsFuncs,
     *    array(
     *      &#x27;beforeSend&#x27; =&gt; # {String|Function} the callable function or function name.
     *    )
     * );
     * &lt;/pre&gt;
     */
    self::_runActionHookFuncByType(&#x27;beforeSend&#x27;,$msg);
    echo $msg;
  }

  private function _runHandleReqFuncByType($type){
    $argvs = func_get_args();
    array_shift( $argvs );
    return isset($this-&gt;_handleReqFuncs[$type]) 
        &amp;&amp; call_user_func_array($this-&gt;_handleReqFuncs[$type], $argvs);
        //&amp;&amp; $this-&gt;_handleReqFuncs[$type]($param);
  }

  private static function _runActionHookFuncByType($type){
    $argvs = func_get_args();
    array_shift( $argvs );
    return isset(self::$_actionHookFuncs[$type]) 
      &amp;&amp; call_user_func_array(self::$_actionHookFuncs[$type], $argvs);
        // &amp;&amp; self::$_actionHookFuncs[$type]($param, $param);
  }

  private function _checkSignature(){
    $signature = $_GET[&quot;signature&quot;];
    $timestamp = $_GET[&quot;timestamp&quot;];
    $nonce = $_GET[&quot;nonce&quot;];	
        		
		$token = $this-&gt;_token;
		$tmpArr = array($token, $timestamp, $nonce);
		sort($tmpArr);
		$tmpStr = implode( $tmpArr );
		$tmpStr = sha1( $tmpStr );
		
		if( $tmpStr == $signature ){
			return true;
		}else{
			return false;
		}
	}

  # {{ ERROR MSG ============================ 
  
  private static function getErrorCode($json){
    return $json[&#x27;errcode&#x27;];
  }
  private static function getErrorMsg ($json){
    return $json[&#x27;errmsg&#x27;];
  }
  private static function getErrorDesc($json){
    $errcode = self::getErrorCode($json);
    return isset( self::$_errList[ $errcode ] )
      ? self::$_errList[ $errcode ]
      : &#x27;ERROR_DESC_NO_FOUND&#x27;;
  }
  private static function checkIsSuc($res){
    $result = !isset($res[&#x27;errcode&#x27;]) || ( 0 == (int)$res[&#x27;errcode&#x27;]);
    return $result;
  }
  # / ERROR MSG }} ============================ 

  # {{ CUSTOM MENU SET/GET/DELETE ===============

  /**
   * @method getMenuList
   * @static 
   * @description Get the current custom menu list
   * @return {Array|null} return list array when success, or nothing for failure
   * @example
   * &lt;pre&gt;
   *       // Your codes here...
   *       $wechat = new WeChatSDK($APPSECRET, $APPID, $_token);
   *       print_r( $wechat-&gt;getMenuList() );
   *       // ...
   * &lt;/pre&gt;
   */
  public function getMenuList(){

    $ACCESS_TOKEN = $this-&gt;_getAccessToken();
    $url = self::$_api_url_root;
    $url = &quot;$url/cgi-bin/menu/get?access_token=$ACCESS_TOKEN&quot;;

    $json = file_get_contents($url);
    $res  = json_decode($json, true);

    if ( self::checkIsSuc($res) ){
      return $res;
    }
  }

  /**
   * @method delMenuList
   * @static 
   * @return {boolen} Delete custom menu successfully?
   * @description Delete the custom menu
   * @example
   * &lt;pre&gt;
   *       // Your codes here...
   *       $wechat = new WeChatSDK($APPSECRET, $APPID, $_token);
   *       print_r( $wechat-&gt;delMenuList() ? &#x27;Yes&quot; : &#x27;No&#x27; );
   *       // ...
   * &lt;/pre&gt;
   */
  public function delMenuList(){
    $ACCESS_TOKEN = $this-&gt;_getAccessToken();

    $url = self::$_api_url_root;
    $url = &quot;$url/cgi-bin/menu/delete?access_token=$ACCESS_TOKEN&quot;;

    $json = file_get_contents($url);
    $res  = json_decode($json, true);

    $isSuc = self::checkIsSuc($res);

    /**
     * @event actionHook::delMenuListResponse
     * @description Trigger once it got the response after try to delete custom menu
     * @example
     * &lt;pre&gt;
     * // How to set it?
     * new WeChatSDK(
     *    $APPSECRET, 
     *    $APPID,
     *    $token,
     *    $handleReqFuncsFuncs,
     *    array(
     *      &#x27;delMenuListResponse&#x27; =&gt; # {String|Function} the callable function or function name.
     *    )
     * );
     * &lt;/pre&gt;
     */
    self::_runActionHookFuncByType(&#x27;delMenuListResponse&#x27;, $res);
    $result = self::checkIsSuc($res);
    if(!$result){
      $res[&#x27;msg&#x27;] = self::getErrorDesc($res);
      $result = $res;
    }

    return $result;
  }

  /**
   * @method setMenuByJson
   * @static
   * @param {string} $json JSON Format.
   * &lt;pre&gt;
   *    {
   *      &quot;button&quot;:[
   *        {	
   *          &quot;type&quot;:&quot;click&quot;,
   *          &quot;name&quot;:&quot;Today&quot;,
   *          &quot;key&quot;:&quot;V1001_TODAY_MUSIC&quot;
   *        },
   *        {
   *          &quot;name&quot;:&quot;More&quot;,
   *          &quot;sub_button&quot;:[
   *            {
   *              &quot;type&quot;:&quot;click&quot;,
   *              &quot;name&quot;:&quot;Hello World&quot;,
   *              &quot;key&quot;:&quot;V1001_HELLO_WORLD&quot;
   *            },
   *            {
   *              &quot;type&quot;:&quot;click&quot;,
   *              &quot;name&quot;:&quot;Good&quot;,
   *              &quot;key&quot;:&quot;V1001_GOOD&quot;
   *            }
   *          ]
   *        }
   *      ]
   *    }
   * &lt;/pre&gt;
   * @example
   * &lt;pre&gt;
   *       // Your codes here...
   *       $wechat = new WeChatSDK($APPSECRET, $APPID, $_token);
   *       $json_string = json_decode( file_get_contents($json_file), true);
   *       $wechat-&gt;setMenuByJson($json_string);
   *       // ...
   * &lt;/pre&gt;
   * @description 
   */
  public function setMenuByJson($json){
    //$json = json_encode( json_decode($json) );

    if(!$json){ return false; }
    $ACCESS_TOKEN = $this-&gt;_getAccessToken();
    $url = self::$_api_url_root;
    $url = &quot;$url/cgi-bin/menu/create?access_token=$ACCESS_TOKEN&quot;;

    $opts = array(
      &#x27;http&#x27; =&gt; array(  
        &#x27;method&#x27; =&gt; &#x27;POST&#x27;,  
        &#x27;header&#x27; =&gt; &quot;Connection: close\r\n&quot;.
                    &quot;Content-Type: application/x-www-form-urlencoded\r\n&quot;.
                    &quot;Content-Length: &quot;.strlen($json).&quot;\r\n&quot;,
        &#x27;content&#x27; =&gt; $json
      )
    );


    $json = file_get_contents(
      $url, false, 
      stream_context_create($opts)
    );

    $res  = json_decode($json, true);

    /**
     * @event actionHook::setMenuListResponse
     * @description Trigger once it got the response after try to set custom menu
     * @example
     * &lt;pre&gt;
     * // How to set it?
     * new WeChatSDK(
     *    $APPSECRET, 
     *    $APPID,
     *    $token,
     *    $handleReqFuncsFuncs,
     *    array(
     *      &#x27;setMenuListResponse&#x27; =&gt; # {String|Function} the callable function or function name.
     *    )
     * );
     * &lt;/pre&gt;
     */
    self::_runActionHookFuncByType(&#x27;setMenuListResponse&#x27;, $res);

    $result = self::checkIsSuc($res);
    if(!$result){
      $res[&#x27;msg&#x27;] = self::getErrorDesc($res);
      $result = $res;
    }
    return $result;
  }

  # ------------------------------------------
  # / CUSTOM MENU SET/GET/DELETE }}} ===============
  private function _getAccessToken(){
    if ( time() &gt; $this-&gt;EXPIRE_TIME ){
      $APPID     = $this-&gt;APPID;
      $APPSECRET = $this-&gt;APPSECRET;

      $url = self::$_api_url_root;
      $url  = &quot;$url/cgi-bin/token?grant_type=client_credential&amp;appid=$APPID&amp;secret=$APPSECRET&quot;;

      $json = file_get_contents($url);
      $res  = json_decode($json, true);
      
      if ( self::checkIsSuc($res) ){
        $this-&gt;ACCESS_TOKEN = $res[&#x27;access_token&#x27;];
        $this-&gt;EXPIRE_TIME  = $res[&#x27;expires_in&#x27;];
      } else {
        $this-&gt;ACCESS_TOKEN = $this-&gt;EXPIRE_TIME = 0;
      }
    }
    return $this-&gt;ACCESS_TOKEN;
  }

  private function _handlePostObj($postObj){
    $MsgType = strtolower((string)$postObj-&gt;MsgType);
    $result = array(
      &#x27;from&#x27;  =&gt; (string) $postObj-&gt;FromUserName,
      &#x27;to&#x27;    =&gt; (string) $postObj-&gt;ToUserName,
      &#x27;time&#x27;  =&gt; (int) $postObj-&gt;CreateTime,
      &#x27;type&#x27;  =&gt; (string) $MsgType
    );

    $this-&gt;_msgFrom = $result[&#x27;from&#x27;];
    $this-&gt;_msgTo   = $result[&#x27;to&#x27;];

    if( property_exists($postObj, &#x27;MsgId&#x27;) ){
      $result[&#x27;id&#x27;] = $postObj-&gt;MsgId;
    }

    switch($result[&#x27;type&#x27;]){
      case &#x27;text&#x27;:
        $result[&#x27;content&#x27;] = (string) $postObj-&gt;Content; // Content 消息内容
        break;

      case &#x27;location&#x27;:
        $result[&#x27;X&#x27;] = (float) $postObj-&gt;Location_X; // Location_X 地理位置纬度
        $result[&#x27;Y&#x27;] = (float) $postObj-&gt;Location_Y; // Location_Y 地理位置经度
        $result[&#x27;S&#x27;] = (float) $postObj-&gt;Scale;      // Scale 地图缩放大小
        $result[&#x27;I&#x27;] = (string) $postObj-&gt;Label;      // Label 地理位置信息
        break;

      case &#x27;image&#x27;:
        $result[&#x27;url&#x27;] = (string) $postObj-&gt;PicUrl; // PicUrl 图片链接，开发者可以用HTTP GET获取
        break;

      case &#x27;link&#x27;:
        $result[&#x27;title&#x27;] = (string) $postObj-&gt;Title;       // Content 消息标题
        $result[&#x27;desc&#x27;]  = (string) $postObj-&gt;Description; // Content 消息标题
        $result[&#x27;url&#x27;]   = (string) $postObj-&gt;Url;         // Content 消息标题
        break;
        
      case &#x27;event&#x27;:
        $result[&#x27;event&#x27;] = strtolower((string) $postObj-&gt;Event);    // 事件类型，subscribe(订阅)、unsubscribe(取消订阅)、CLICK(自定义菜单点击事件)
        $result[&#x27;key&#x27;]   = (string) $postObj-&gt;EventKey; // 事件KEY值，与自定义菜单接口中KEY值对应 
        break;

    }

    return $result;
  }

  // 请求消息的来源及流向
  private $_msgFrom;
  private $_msgTo;

  private $_token;
  private $_handleReqFuncs;
  private static $_actionHookFuncs;

  private $APPSECRET;
  private $APPID;

  private $ACCESS_TOKEN;
  private $EXPIRE_TIME = 0;

}
</pre>

</div> </div>
        <div id="sidebar" class="span3"> <!-- vim:set filetype=html: -->
<ul class="nav nav-list">

<li class="nav-header">Classes</li>

<li>
<a href="../classes/WeChatSDK.html">WeChatSDK</a>
</li>

<li class="divider"></li>







<li class="nav-header">Files</li>
<ul><li>WechatSDK.php/<ul></ul></li></ul>
<li class="divider"></li>

</ul> </div>
      </div>
    </div>
  </body>
</html>
<script type="text/javascript" src="../assets/js/jquery-1.8.2.min.js"></script>
<script type="text/javascript"> if($('.prettyprint').length)$.getScript("https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js?lang=php"); </script>
